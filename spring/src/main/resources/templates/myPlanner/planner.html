<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/common :: head(title)" />
<head>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.8/index.global.min.js"></script>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <style>
    .cc-selector input{
        margin:0;padding:0;
        -webkit-appearance:none;
           -moz-appearance:none;
                appearance:none;

        cursor:pointer;
        background-size:contain;
        background-repeat:no-repeat;
        display:inline-block;
        width:100px;height:70px;
        -webkit-transition: all 100ms ease-in;
           -moz-transition: all 100ms ease-in;
                transition: all 100ms ease-in;
        -webkit-filter: brightness(0) grayscale(1) opacity(1);
           -moz-filter: brightness(0) grayscale(1) opacity(1);
                filter: brightness(0) grayscale(1) opacity(1);
    }
    .vacation{background-image:url(img/eventType/vacation.png);}
    .diet{background-image:url(img/eventType/diet.png);}
    .shopping{background-image:url(img/eventType/shopping.png);}
    .location{background-image:url(img/eventType/location.png);}
    .text{background-image:url(img/eventType/text.png);}


    .cc-selector input:hover{
        -webkit-filter: brightness(1.2) grayscale(.5) opacity(.9);
           -moz-filter: brightness(1.2) grayscale(.5) opacity(.9);
                filter: brightness(1.2) grayscale(.5) opacity(.9);
    }

    .cc-selector input:checked {
        -webkit-filter: none;
           -moz-filter: none;
                filter: none;
    }

    #pagingul{
        text-align: center;
        display: inline-block;
        border: 1px solid #ccc;
        border-right: 0;
        padding-left :0;
    }

    #pagingul li {
        text-align: center;
        float: left;
        list-style:none;

    }

    #pagingul li a {
        display: block;
        font-size: 14px;
        color: black;
        padding: 9px 12px;
        border-right: solid 1px #ccc;
        box-sizing: border-box;
        text-decoration-line:none;
    }

    #pagingul li.on {
        background: #eda712;
    }

    #pagingul li.on a {
        color: #fff;
    }

  </style>
  <script>
   $(document).ready(function (){
      var token = $("meta[name='_csrf']").attr("content");
	  var header = $("meta[name='_csrf_header']").attr("content");

      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar : {
		  start : 'prev next today',
		  center : 'title',
		  end : 'dayGridMonth,dayGridWeek,dayGridDay,listMonth'
		},
		titleFormat : function(date) {
		  return date.date.year + '년 ' + (parseInt(date.date.month) + 1) + '월';
		},
		navLinks: true,
		selectable : true,
<!--		droppable : true,-->
<!--		editable : true,-->
		nowIndicator: true,
		locale: 'ko',
		googleCalendarApiKey: 'AIzaSyD7FEF1RyDXeRs5iUzQ865DTAeHlbT1vcM', //구글 캘린더 API KEY
		eventSources: [
          {
            url: 'myPlanner/api/events/',
            color: 'yellow',
            textColor: 'black'
          },
          {
            googleCalendarId : 'ko.south_korea#holiday@group.v.calendar.google.com', //구글 캘린더 아이디 - 공휴일 가져오기
            color: 'white',
            textColor: 'red'
          }
        ],
        select: function (arg) { // 드래그로 이벤트 생성.
          $("#type_event_modal").modal("show"); // modal 나타내기
          $("#type_event_save").off('click').on("click",function(){
              var eventType = $('input:radio[name="type_event"]:checked').val();
              if(eventType == "vacation" || eventType == "diet" || eventType == "shopping" || eventType == "location" || eventType == "text") {

                $('#vacation_input').css('display','none');
                $('#diet_input').css('display','none');
                $('#shopping_input').css('display','none');
                $('#location_input').css('display','none');
                $('#text_input').css('display','none');

                if(eventType == "vacation") {
                  $('#vacation_input').css('display','block');
                  $('#add_event_vacation').attr('disabled', false);
                } else if(eventType == "diet") {
                  $('#diet_input').css('display','block');
                  $('#add_event_diet').attr('disabled', false);
                  $("#add_diet_by_api").off('click').on("click",function(){
                    $("#add_diet_by_api_modal").modal("show");

                    let pageNo = 1;
                    const numOfRows = 100;
                    let serviceKey = "YfVszWFGgZBtStWJ429k2RIkV3b1vpS4obo%2FKLxcU15enrSNaCvSNO3TLZKnGjaAfL3trm9jk6X7jFG86kpm6Q%3D%3D"
                    let totalCount;
                    let resultCode;

                    //totalCount와 resultCode를 먼저 받아옴으로써 api가 정상적인지와 총 데이터의 갯수를 파악
                    $.ajax({
                        type: "GET",
                        url: `http://apis.data.go.kr/1471000/FoodNtrIrdntInfoService1/getFoodNtrItdntList1?ServiceKey=${serviceKey}&numOfRows=${numOfRows}&pageNo=${pageNo}&type=json`,
                        data: {},
                        async: false,
                        success: function(data) {
                            totalCount = data.body.totalCount;
                            resultCode = data.header.resultCode;
                        }
                    })
                    if(resultCode != "00"){
                        alert("공공데이터 API에 문제가 있습니다! 잠시 후 다시 시도하세요.");
                    }

                    const totalPage = Math.ceil(totalCount/numOfRows)+1;

                    let pageCount = 10; //페이징에 나타낼 페이지 수

                    displayData(pageNo);
                    paging(totalCount, numOfRows, pageCount, pageNo);

                    //데이터 가져오기
                    function setTable(pageNo){
                        $.ajax({
                            type: "GET",
                            url: `http://apis.data.go.kr/1471000/FoodNtrIrdntInfoService1/getFoodNtrItdntList1?ServiceKey=${serviceKey}&numOfRows=${numOfRows}&pageNo=${pageNo}&type=json`,
                            data: {},
                            success: function(data){
                               let bodyData = data.body;
                               let table_html='';
                               for (let i = 0; i < numOfRows; i++) {
                                    table_html += '<tr>';
                                    table_html += '  <td>'+bodyData.items[i]['DESC_KOR']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['SERVING_WT']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT1']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT2']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT3']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT4']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT5']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT6']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT7']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT8']+'</td>';
                                    table_html += '  <td>'+bodyData.items[i]['NUTR_CONT9']+'</td>';
                                    table_html += '</tr>';
                               }
                               $('#api>tbody').append(table_html);
                            }
                        })
                    }

                    function displayData(pageNo) {
                      $('#api>tbody').empty();
                      setTable(pageNo);
                    }

                    function paging(totalCount, numOfRows, pageCount, pageNo) {

                      if(totalPage<pageCount){
                        pageCount=totalPage;
                      }

                      let pageGroup = Math.ceil(pageNo / pageCount); // 페이지 그룹
                      let last = pageGroup * pageCount; //화면에 보여질 마지막 페이지 번호

                      if (last > totalPage) {
                        last = totalPage;
                      }

                      let first = last - (pageCount - 1); //화면에 보여질 첫번째 페이지 번호
                      let next = last + 1;
                      let prev = first - 1;

                      let pageHtml = "";

                      if (prev > 0) {
                        pageHtml += "<li><a href='#' id='prev'> 이전 </a></li>";
                      }

                     //페이징 번호 표시
                      for (var i = first; i <= last; i++) {
                        if (pageNo == i) {
                          pageHtml +=
                            "<li class='on'><a href='#' id='" + i + "'>" + i + "</a></li>";
                        } else {
                          pageHtml += "<li><a href='#' id='" + i + "'>" + i + "</a></li>";
                        }
                      }

                      if (last < totalPage) {
                        pageHtml += "<li><a href='#' id='next'> 다음 </a></li>";
                      }

                      $("#pagingul").html(pageHtml);
                      let displayCount = "";
                      displayCount = "현재 1 - " + totalPage + " 페이지 / " + totalCount + "건";
                      $("#displayCount").text(displayCount);


                      //페이징 번호 클릭 이벤트
                      $("#pagingul li a").click(function () {
                        let $id = $(this).attr("id");
                        selectedPage = $(this).text();

                        if ($id == "next") selectedPage = next;
                        if ($id == "prev") selectedPage = prev;

                        pageNo = selectedPage;
                        paging(totalCount, numOfRows, pageCount, pageNo);
                        displayData(pageNo, numOfRows);
                      });
                    }

                  })
                } else if(eventType == "shopping") {
                  $('#shopping_input').css('display','block');
                  $('#add_event_shopping').attr('disabled', false);
                } else if(eventType == "location") {
                  $('#location_input').css('display','block');
                  $('#add_event_location').attr('disabled', false);
                } else if(eventType == "text") {
                  $('#text_input').css('display','block');
                  $('#add_event_text').attr('disabled', false);
                }

                $("#add_event_modal").modal("show");
                document.getElementById("add_event_start_date").value = moment(arg.start).format('YYYY-MM-DD');
                document.getElementById("add_event_end_date").value = moment(arg.end).format('YYYY-MM-DD');
                document.getElementById("add_event_start_time").value = moment(arg.start).format('HH:mm');
                document.getElementById("add_event_end_time").value = moment(arg.end).format('HH:mm');

                $("#add_event_save").off('click').on("click",function(){  // modal의 추가 버튼 클릭 시
                  var text = $("#add_event_text").val();
                  var start_date = $("#add_event_start_date").val();
                  var start_time = $("#add_event_start_time").val();
                  var end_date = $("#add_event_end_date").val();
                  var end_time = $("#add_event_end_time").val();

                  var allDay = true;
                  if($('input:radio[id=set_time]').is(':checked')){
                    allDay = false;
                  }

                  var start = start_date + " " + start_time;
                  var end = end_date + " " + end_time;

                  //내용 입력 여부 확인
                  if(text == null || text == ""){
                    alert("내용을 입력하세요.");
                  }else if(start_date == "" || end_date ==""){
                    alert("날짜를 입력하세요.");
                  }else if(new Date(end)- new Date(start) < 0){ // date 타입으로 변경 후 확인
                    alert("종료일이 시작일보다 먼저입니다.");
                  }else{ // 정상적인 입력 시
                    var obj = {
                      "title" : text,
                      "start" : start,
                      "end" : end,
                      "allDay" : allDay
                    }//전송할 객체 생성
                    var event = JSON.stringify(obj)
                    $.ajax({
                      url: "/myPlanner/create",
                      method: "POST",
                      dataType: "text",
                      data: event,
                      contentType: 'application/json',
                      beforeSend : function(xhr) {
                        xhr.setRequestHeader(header, token);
                      },
                      success : function(){
                        alert("등록을 완료하였습니다!");
                      },
                      fail : function (request, status, error){
                        alert("에러 발생" + error)
                      },
                      complete : function(){
                        location.replace("");
                    }
                  })

                  calendar.unselect();
                  }
                });
              } else {
                alert("일정 유형을 선택해 주세요!")
              }

          })
        },
        eventClick: function(arg) {
          $("#info_event_modal").modal("show"); // modal 나타내기
          document.getElementById("info_event_start_date").value = moment(arg.event.start).format('YYYY-MM-DD');
          document.getElementById("info_event_end_date").value = moment(arg.event.end).format('YYYY-MM-DD');
          document.getElementById("info_event_start_time").value = moment(arg.event.start).format('HH:mm');
          document.getElementById("info_event_end_time").value = moment(arg.event.end).format('HH:mm');
          document.getElementById("info_event_text").value = arg.event.title;

          $("#event_delete").off('click').on("click",function(){
            if(confirm("해당 일정을 삭제하시겠습니까 ?")){
              var obj = {
                "id" : arg.event.id,
                "title" : arg.event.title,
                "start" : arg.event.start,
                "end" : arg.event.end,
                "allDay" : arg.event.allDay
              }//전송할 객체 생성
              var event = JSON.stringify(obj)
              $.ajax({
                url: "/myPlanner/delete",
                method: "DELETE",
                dataType: "text",
                data: event,
                contentType: 'application/json',
                beforeSend : function(xhr) {
                  xhr.setRequestHeader(header, token);
                },
                success : function(){
				  alert("삭제를 완료하였습니다!");
		        },
                fail : function (request, status, error){
                  alert("에러 발생" + error)
                },
                complete : function(){
                  location.replace("");
                }
              })
            }
          })
        }
      });
      calendar.render();
   });
    </script>
</head>
<body>
<nav th:replace="fragments/common :: menu(menu)" />
<div id='calendar'></div>
<!-- 이벤트 유형 선택 modal -->
<div class="modal fade" id="type_event_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="type_event_title">일정 유형을 선택하세요.</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form class = "modal-body">
                <div class="cc-selector">
                    <div>
                        <input type="radio" class="type_event_input vacation" id="vacation" value="vacation" name="type_event">
                        <label for="vacation">휴가</label>
                    </div>
                    <div>
                        <input type="radio" class="type_event_input diet" id="diet" value="diet" name="type_event">
                        <label for="diet">식단</label>
                    </div>
                    <div>
                        <input type="radio" class="type_event_input shopping" id="shopping" value="shopping" name="type_event" >
                        <label for="shopping">소비</label>
                    </div>
                    <div>
                        <input type="radio" class="type_event_input location" id="location" value="location" name="type_event">
                        <label for="location">장소</label>
                    </div>
                    <div>
                        <input type="radio" class="type_event_input text" id="text" value="text" name="type_event">
                        <label for="text">텍스트로 입력하기</label>
                    </div>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="type_event_save">선택</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="type_event_modal_close">취소</button>
            </div>
        </div>
    </div>
</div>
<!-- 이벤트 추가 modal -->
<div class="modal fade" id="add_event_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="add_event_title">일정을 입력하세요.</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="event" class="form-group">
          <div class="form-check">
            <input class="form-check-input" type="radio" id="all_time" name="all_or_set_time" onchange="setTimeDisplay()" checked="checked">
            <label class="form-check-label all_time" for="all_time">종일</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" id="set_time" name="all_or_set_time" onchange="setTimeDisplay()">
            <label class="form-check-label set_time" for="set_time">시간 지정</label>
          </div>
          <label for="add_event_start_date" class="col-form-label">시작 날짜</label>
          <input type="date" class="form-control" id="add_event_start_date" name="calendar_start_date">
          <label for="add_event_start_time" class="col-form-label">시작 시간</label>
          <input type="time" class="form-control" id="add_event_start_time" name="calendar_start_time" disabled="true" value="00:00">
          <label for="add_event_end_date" class="col-form-label">종료 날짜</label>
          <input type="date" class="form-control" id="add_event_end_date" name="calendar_end_date">
          <label for="add_event_end_time" class="col-form-label">종료 시간</label>
          <input type="time" class="form-control" id="add_event_end_time" name="calendar_end_time" disabled="true" value="00:00">
          <div id="vacation_input">
              <label for="add_event_vacation" class="col-form-label">휴가 내역</label>
              <input type="text" class="form-control" id="add_event_vacation" name="calendar_content" disabled="true">
          </div>
          <div class= "buttons" id="diet_input">
              <label for="add_event_diet" class="col-form-label">식단 추가 (기호 단위는 생략해서 입력해주세요.)</label>
              <input type="button" id="add_diet_by_api" class="btnAdd btn btn-dark" value="음식 영양소 검색 등록">
              <div id="add_event_diet" disabled="true">
                  <input type="text" id="food_name" class="form-control" name="calendar_content" placeholder="음식명 예) 김치찌개, 쌀밥, 김치">
                  <input type="text" id="kcal" class="form-control" name="calendar_content" placeholder="1회 섭취 칼로리 합(kcal)">
                  <input type="text" id="carbohydrate" class="form-control" name="calendar_content" placeholder="1회 섭취 탄수화물 합(g)">
                  <input type="text" id="protein" class="form-control" name="calendar_content" placeholder="1회 섭취 단백질 합(g)">
                  <input type="text" id="fat" class="form-control" name="calendar_content" placeholder="1회 섭취 지방 합(g)">
                  <input type="text" id="cholesterol" class="form-control" name="calendar_content" placeholder="1회 섭취 콜레스테롤 합(g)">
                  <input type="text" id="fiber" class="form-control" name="calendar_content" placeholder="1회 섭취 식이섬유 합(g)">
                  <input type="text" id="salt" class="form-control" name="calendar_content" placeholder="1회 섭취 나트륨 합(g)">
              </div>
          </div>
          <div id="shopping_input">
              <label for="add_event_shopping" class="col-form-label">소비 기록</label>
              <input type="text" class="form-control" id="add_event_shopping" name="calendar_content" disabled="true">
          </div>
          <div id="location_input">
              <label for="add_event_location" class="col-form-label">장소 추가</label>
              <input type="text" class="form-control" id="add_event_location" name="calendar_content" disabled="true">
          </div>
          <div id="text_input">
              <label for="add_event_text" class="col-form-label">텍스트 추가</label>
              <input type="text" class="form-control" id="add_event_text" name="calendar_content" disabled="true">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="add_event_save">추가</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="add_event_modal_close">취소</button>
      </div>
    </div>
  </div>
</div>

<!-- 이벤트 상세 정보 modal -->
<div class="modal fade" id="info_event_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="info_event_title">일정 정보</h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <label for="info_event_start_date" class="col-form-label">시작 날짜</label>
          <input type="date" class="form-control" id="info_event_start_date" name="info_calendar_start_date" disabled="true">
          <label for="info_event_start_time" class="col-form-label">시작 시간</label>
          <input type="time" class="form-control" id="info_event_start_time" name="info_calendar_start_time" disabled="true">
          <label for="info_event_end_date" class="col-form-label">종료 날짜</label>
          <input type="date" class="form-control" id="info_event_end_date" name="info_calendar_end_date" disabled="true">
          <label for="info_event_end_time" class="col-form-label">종료 시간</label>
          <input type="time" class="form-control" id="info_event_end_time" name="info_calendar_end_time" disabled="true">
          <label for="info_event_text" class="col-form-label">일정 내용</label>
          <input type="text" class="form-control" id="info_event_text" name="info_calendar_text" disabled="true">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="info_event_modal_close">취소</button>
        <button type="submit" class="btn btn-warning" id="event_update">수정</button>
        <button type="submit" class="btn btn-danger" id="event_delete">삭제</button>
      </div>
    </div>
  </div>
</div>

<!-- 식단 선택 api modal -->
<div class="modal fade" id="add_diet_by_api_modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="add_diet_title">식단 정보</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body app">
                <span id="displayCount"></span>
                <table class="table table-hover" id="api" style="font-size: 1vh">
                    <thead id="table_head">
                        <tr>
                            <th scope="col">식품명</th>
                            <th scope="col">1회제공량 (g)</th>
                            <th scope="col">열량 (kcal)</th>
                            <th scope="col">탄수화물(g)</th>
                            <th scope="col">단백질(g)</th>
                            <th scope="col">지방(g)</th>
                            <th scope="col">당류 (g)</th>
                            <th scope="col">나트륨 (g)</th>
                            <th scope="col">콜레스테롤 (g)</th>
                            <th scope="col">포화지방산 (g)</th>
                            <th scope="col">트랜스지방산 (g)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <ul id="pagingul"></ul>
            </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="add_diet_modal_close">취소</button>
            </div>
        </div>
    </div>
</div>


<footer th:replace="fragments/common :: footer"></footer>
</body>
<script>
  function setTimeDisplay(){
    if($('input:radio[id=all_time]').is(':checked')){
        $('#add_event_start_time').val("00:00");
        $('#add_event_start_time').attr("disabled", true);
        $('#add_event_end_time').val("00:00");
        $('#add_event_end_time').attr("disabled", true);
    }else if($('input:radio[id=set_time]').is(':checked')){
        $('#add_event_start_time').attr("disabled", false);
        $('#add_event_end_time').attr("disabled", false);
    }
  }

  function resetExtraInputs() {
     $(".add_event_text_extra").remove();
     $(".btnRemove").remove();
     $("br").remove();
  }

  $('.modal').on('hidden.bs.modal', function (e) {
	$(this).find('form')[0].reset();
	setTimeDisplay();
	resetExtraInputs();
  })

</script>

